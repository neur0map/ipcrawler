{# Comprehensive HTML Report Template for IPCrawler #}
{% extends "base/layout.html.j2" %}
{% import "base/macros.html.j2" as macros %}

{% block title %}{{ title }}{% endblock %}

{% block header_title %}{{ title }}{% endblock %}
{% block header_subtitle %}
    Target: <span class="target">{{ target }}</span>
    {% if workflow %}| Workflow: <span class="workflow">{{ workflow }}</span>{% endif %}
{% endblock %}

{% block content %}
    {# Summary Section #}
    {% if summary %}
        {% call macros.section("Executive Summary", icons.chart, collapsible=false, class="summary-section") %}
            {% set summary_cards = [
                {'value': summary.total_hosts, 'label': 'Total Hosts', 'icon': icons.server, 'color': colors.primary},
                {'value': summary.up_hosts, 'label': 'Hosts Up', 'icon': icons.check, 'color': colors.success},
                {'value': summary.open_ports, 'label': 'Open Ports', 'icon': icons.port, 'color': colors.info},
                {'value': summary.services_detected, 'label': 'Services', 'icon': icons.service, 'color': colors.secondary},
                {'value': summary.vulnerabilities, 'label': 'Vulnerabilities', 'icon': icons.warning, 'color': colors.error if summary.vulnerabilities > 0 else colors.success},
                {'value': "%.1fs"|format(summary.duration), 'label': 'Duration', 'icon': icons.clock, 'color': colors.muted}
            ] %}
            {{ macros.summary_grid(summary_cards) }}
        {% endcall %}
    {% endif %}

    {# Host Discovery Results #}
    {% if hosts %}
        {% call macros.section("Host Discovery Results", icons.server, collapsible=true) %}
            <div class="hosts-overview">
                <p class="section-description">
                    Discovered {{ hosts|length }} host(s) during network reconnaissance.
                </p>
            </div>
            
            {% for host in hosts %}
                {{ macros.host_card(host) }}
            {% endfor %}
        {% endcall %}
    {% endif %}

    {# HTTP/HTTPS Scan Results #}
    {% if http_scan %}
        {% call macros.section("HTTP/HTTPS Security Assessment", icons.web, collapsible=true) %}
            <div class="http-overview">
                {% if http_scan.services %}
                    <p class="section-description">
                        Analyzed {{ http_scan.services|length }} HTTP service(s) for security vulnerabilities and misconfigurations.
                    </p>
                {% endif %}
                
                {% if http_scan.fallback_mode %}
                    <div class="alert alert-info">
                        <strong>Note:</strong> HTTP scan completed using fallback mode ({{ http_scan.scan_engine|default('curl+nslookup') }}).
                    </div>
                {% endif %}
            </div>

            {# HTTP Services #}
            {% if http_scan.services %}
                <div class="http-services">
                    <h4>{{ icons.service }} HTTP Services ({{ http_scan.services|length }})</h4>
                    
                    {% set service_headers = ['URL', 'Status', 'Server', 'Technologies', 'Paths'] %}
                    {% set service_rows = [] %}
                    {% for service in http_scan.services %}
                        {% set row = [
                            '<a href="' + service.url + '" target="_blank">' + service.url + '</a>',
                            '<span class="status-code ' + ('status-success' if service.status_code < 400 else 'status-error') + '">' + service.status_code|string + '</span>',
                            service.server|default('Unknown'),
                            service.tech_summary|default('None detected'),
                            service.discovered_paths|length|string + ' found' if service.discovered_paths else '0'
                        ] %}
                        {{ service_rows.append(row) or "" }}
                    {% endfor %}
                    
                    {{ macros.data_table(service_headers, service_rows, sortable=true) }}
                </div>
            {% endif %}

            {# Vulnerabilities by Severity #}
            {% if http_scan.vulnerabilities_by_severity %}
                <div class="vulnerabilities-section">
                    <h4>{{ icons.shield }} Security Vulnerabilities</h4>
                    
                    {% for severity in ['critical', 'high', 'medium', 'low', 'info'] %}
                        {% if http_scan.vulnerabilities_by_severity[severity] %}
                            <div class="vulnerability-category">
                                <h5 class="{{ severity | severity_class }}">
                                    {{ severity.title() }} Severity ({{ http_scan.vulnerabilities_by_severity[severity]|length }})
                                </h5>
                                {{ macros.vulnerability_list(http_scan.vulnerabilities_by_severity[severity]) }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}

            {# DNS Information #}
            {% if http_scan.dns_records or http_scan.subdomains %}
                <div class="dns-section">
                    <h4>{{ icons.dns }} DNS Information</h4>
                    
                    {% if http_scan.subdomains %}
                        <div class="subdomains">
                            <h5>Discovered Subdomains ({{ http_scan.subdomains|length }})</h5>
                            <div class="subdomain-list">
                                {% for subdomain in http_scan.subdomains[:20] %}
                                    <span class="subdomain-item">{{ subdomain }}</span>
                                {% endfor %}
                                {% if http_scan.subdomains|length > 20 %}
                                    <span class="more-items">... and {{ http_scan.subdomains|length - 20 }} more</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if http_scan.dns_records %}
                        <div class="dns-records">
                            <h5>DNS Records ({{ http_scan.dns_records|length }})</h5>
                            
                            {% set dns_headers = ['Type', 'Value'] %}
                            {% set dns_rows = [] %}
                            {% for record in http_scan.dns_records[:10] %}
                                {% set row = [record.type|default('N/A'), record.value|default('N/A')] %}
                                {{ dns_rows.append(row) or "" }}
                            {% endfor %}
                            
                            {{ macros.data_table(dns_headers, dns_rows) }}
                        </div>
                    {% endif %}
                </div>
            {% endif %}
        {% endcall %}
    {% endif %}

    {# SmartList Wordlist Recommendations #}
    {% if smartlist %}
        {% call macros.section("SmartList Wordlist Recommendations", icons.list, collapsible=true) %}
            <div class="smartlist-overview">
                {% if smartlist.summary %}
                    <p class="section-description">
                        {{ smartlist.summary.recommendation|default('Analyzed services and generated intelligent wordlist recommendations.') }}
                    </p>
                    
                    {% if smartlist.recommendation_summary %}
                        {% set smartlist_cards = [
                            {'value': smartlist.recommendation_summary.services_analyzed, 'label': 'Services Analyzed', 'icon': icons.service},
                            {'value': smartlist.recommendation_summary.total_wordlists, 'label': 'Wordlists Recommended', 'icon': icons.list},
                            {'value': smartlist.recommendation_summary.confidence_counts.high, 'label': 'High Confidence', 'icon': icons.check, 'color': colors.success},
                            {'value': smartlist.recommendation_summary.confidence_counts.medium, 'label': 'Medium Confidence', 'icon': icons.warning, 'color': colors.warning}
                        ] %}
                        {{ macros.summary_grid(smartlist_cards) }}
                    {% endif %}
                {% endif %}
            </div>

            {% if smartlist.wordlist_recommendations %}
                <div class="wordlist-recommendations-section">
                    <h4>{{ icons.target }} Recommendations by Service</h4>
                    
                    {% for service_rec in smartlist.wordlist_recommendations %}
                        <div class="service-recommendation">
                            <div class="service-header">
                                <h5>{{ service_rec.service }} ({{ service_rec.service_name }})</h5>
                                {% if service_rec.detected_technology %}
                                    <span class="detected-tech">{{ service_rec.detected_technology }}</span>
                                {% endif %}
                                {{ macros.confidence_badge(service_rec.confidence) }}
                                <span class="total-score">Score: {{ service_rec.total_score }}</span>
                            </div>
                            
                            {% if service_rec.top_wordlists %}
                                {{ macros.wordlist_recommendations(service_rec.top_wordlists[:5]) }}
                            {% endif %}
                            
                            {% if service_rec.context and service_rec.context.matched_rules %}
                                <div class="matched-rules">
                                    <strong>Matched Rules:</strong>
                                    {% for rule in service_rec.context.matched_rules %}
                                        <span class="rule-tag">{{ rule }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if service_rec.context and service_rec.context.fallback_used %}
                                <div class="alert alert-warning">
                                    <small>{{ icons.warning }} Generic fallback was used for this service</small>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endcall %}
    {% endif %}

    {# Mini Spider URL Discovery #}
    {% if mini_spider %}
        {% call macros.section("Mini Spider URL Discovery", icons.spider, collapsible=true) %}
            <div class="mini-spider-overview">
                <p class="section-description">
                    {% if mini_spider.total_discovered_urls %}
                        Discovered {{ mini_spider.total_discovered_urls }} unique URLs across {{ mini_spider.category_stats|length }} categories.
                    {% else %}
                        URL discovery and crawling analysis completed.
                    {% endif %}
                </p>
                
                {% if mini_spider.category_stats %}
                    {% set spider_cards = [] %}
                    {% for category, stats in mini_spider.category_stats.items() %}
                        {% set card = {'value': stats.count, 'label': category.title() + ' URLs', 'icon': icons.url} %}
                        {{ spider_cards.append(card) or "" }}
                    {% endfor %}
                    {{ macros.summary_grid(spider_cards) }}
                {% endif %}
            </div>

            {# URL Categories #}
            {% if mini_spider.category_stats %}
                <div class="url-categories">
                    <h4>{{ icons.category }} URLs by Category</h4>
                    
                    {% for category, stats in mini_spider.category_stats.items() %}
                        <div class="category-section">
                            {{ macros.url_list(stats.urls, category, max_display=20) }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {# Interesting Findings #}
            {% if mini_spider.findings_by_type %}
                <div class="interesting-findings">
                    <h4>{{ icons.discovery }} Interesting Findings</h4>
                    
                    {% for finding_type, findings in mini_spider.findings_by_type.items() %}
                        <div class="finding-type">
                            <h5>{{ finding_type.title() }} ({{ findings|length }})</h5>
                            
                            {% for finding in findings[:10] %}
                                <div class="finding-item {{ finding.severity | severity_class if finding.severity else '' }}">
                                    <div class="finding-header">
                                        <span class="finding-url">{{ finding.url }}</span>
                                        {% if finding.severity %}
                                            <span class="finding-severity {{ finding.severity | severity_class }}">{{ finding.severity.upper() }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    {% if finding.description %}
                                        <div class="finding-description">{{ finding.description }}</div>
                                    {% endif %}
                                    
                                    {% if finding.details %}
                                        <div class="finding-details">
                                            <pre class="finding-evidence">{{ finding.details | truncate_smart(300) }}</pre>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                            
                            {% if findings|length > 10 %}
                                <div class="more-findings">
                                    ... and {{ findings|length - 10 }} more {{ finding_type }} findings
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endcall %}
    {% endif %}

    {# Raw Data Section (Collapsible) #}
    {% if data %}
        {% call macros.section("Raw Data", icons.data, collapsible=true, class="raw-data-section") %}
            <div class="alert alert-info">
                <strong>Note:</strong> This section contains the complete raw data from the scan in JSON format.
                It can be useful for debugging or integrating with other tools.
            </div>
            
            <details>
                <summary>Click to view raw JSON data</summary>
                <pre class="json-data">{{ data | json_pretty }}</pre>
            </details>
        {% endcall %}
    {% endif %}
{% endblock %}

{% block extra_styles %}
    <style>
        /* Additional styles for comprehensive report */
        .section-description {
            color: {{ colors.muted }};
            margin-bottom: 25px;
            font-style: italic;
            line-height: 1.7;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid;
        }
        
        .alert-info {
            background: rgba(0, 170, 255, 0.1);
            border-left-color: {{ colors.info }};
            color: {{ colors.info }};
        }
        
        .alert-warning {
            background: rgba(255, 170, 0, 0.1);
            border-left-color: {{ colors.warning }};
            color: {{ colors.warning }};
        }
        
        .status-code {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.85em;
        }
        
        .subdomain-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .subdomain-item {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            color: {{ colors.info }};
        }
        
        .more-items {
            color: {{ colors.muted }};
            font-style: italic;
            padding: 4px 8px;
        }
        
        .service-recommendation {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .service-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .service-header h5 {
            color: {{ colors.primary }};
            margin: 0;
            flex: 1;
        }
        
        .detected-tech {
            background: {{ colors.secondary }};
            color: #000;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .total-score {
            color: {{ colors.muted }};
            font-size: 0.9em;
        }
        
        .matched-rules {
            margin-top: 15px;
            color: {{ colors.muted }};
            font-size: 0.9em;
        }
        
        .rule-tag {
            background: #333;
            color: {{ colors.info }};
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        .category-section {
            margin-bottom: 30px;
        }
        
        .finding-item {
            background: #222;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .finding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .finding-url {
            color: {{ colors.info }};
            font-weight: bold;
            word-break: break-all;
            flex: 1;
            margin-right: 10px;
        }
        
        .finding-severity {
            font-size: 0.8em;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .finding-description {
            color: {{ colors.muted }};
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .finding-evidence {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 3px;
            font-size: 0.85em;
            color: {{ colors.info }};
            overflow-x: auto;
        }
        
        .more-findings {
            text-align: center;
            color: {{ colors.muted }};
            font-style: italic;
            padding: 10px;
            background: #0f0f0f;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .raw-data-section {
            margin-top: 40px;
        }
        
        details {
            margin-top: 15px;
        }
        
        summary {
            cursor: pointer;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px;
            color: {{ colors.primary }};
            font-weight: bold;
        }
        
        summary:hover {
            background: #222;
        }
        
        details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none;
        }
        
        details[open] .json-data {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            margin-top: 0;
        }
    </style>
{% endblock %}