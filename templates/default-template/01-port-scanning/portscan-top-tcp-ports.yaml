metadata:
  name: "Top TCP Ports"
  description: "Performs an Nmap scan of the top 1000 TCP ports"
  type: "portscan"
  priority: 0
  version: "1.0"
  author: "IPCrawler YAML Plugin System"

variables:
  # Plugin-specific variables - completely autonomous
  min_rate: "1000"
  max_rate: "5000"
  top_ports: "1000"

conditions:
  when:
    custom_condition: "not target.ports"  # Only if no custom ports specified
  targets:
    timeout: 1800  # 30 minutes timeout

options:
  - name: "top_ports"
    type: "integer"
    default: 1000
    help: "Number of top ports to scan"
  - name: "min_rate"
    type: "integer"
    default: 1000
    help: "Minimum packet rate per second"
  - name: "max_rate"
    type: "integer"
    default: 5000
    help: "Maximum packet rate per second"

execution:
  commands:
    - name: "quick_tcp_scan"
      command: "nmap -T4 --min-rate={min_rate} --max-rate={max_rate} --host-timeout=300s --script-timeout=60s -sV -sC{os_detection} --top-ports {top_ports} -oN \"{scandir}/_quick_tcp_nmap.txt\" -oX \"{scandir}/xml/_quick_tcp_nmap.xml\" {address}"
      timeout: 1800

  manual_commands:
    - description: "(nmap) Quick TCP port scan"
      command: "nmap -T4 --top-ports 1000 -sV -sC {address}"
    - description: "(nmap) Quick TCP with OS detection"
      command: "nmap -T4 --top-ports 1000 -sV -sC -A --osscan-guess {address}"

output:
  service_detection:
    - pattern: "^(\\d+)/(tcp|udp)\\s+open\\s+(\\S+)"
      service_name: "{match3}"
    # Special WinRM detection for ports 5985/5986
    - pattern: "^(5985|5986)/tcp\\s+open\\s+http"
      service_name: "wsman"
      condition: "winrm_detected"

  patterns:
    - pattern: "(?i)Nmap scan report for ([^\\s]+)"
      description: "Target: {match1}"
      severity: "info"
      category: "discovery"
    
    - pattern: "(?i)(\\d+)/(tcp|udp)\\s+open\\s+(\\S+)\\s+(.+)"
      description: "Open Port: {match1}/{match2} - {match3} ({match4})"
      severity: "info"
      category: "ports"
    
    - pattern: "(?i)OS details: (.+)"
      description: "Operating System: {match1}"
      severity: "info"
      category: "os_detection"
    
    - pattern: "(?i)Device type: (.+)"
      description: "Device Type: {match1}"
      severity: "info"
      category: "os_detection"

requirements:
  tools:
    - name: "nmap"
      check_command: "nmap --version"
      install_hint: "apt-get install nmap"

debug:
  log_level: "info"
  trace_decisions: true
  show_command_output: false