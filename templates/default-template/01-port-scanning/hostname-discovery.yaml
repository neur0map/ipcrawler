metadata:
  name: HTTP Hostname Discovery
  description: Discovers hostnames through HTTP redirects and headers
  type: portscan
  priority: -10
  version: '1.0'
  author: IPCrawler YAML Plugin System
conditions:
  targets:
    timeout: 180
options:
- name: http_timeout
  type: integer
  default: 10
  help: HTTP request timeout in seconds
- name: check_https
  type: boolean
  default: true
  help: Also check HTTPS endpoints
execution:
  commands:
  - name: discover_http_hostnames
    command: curl -s -I --max-time {http_timeout} --connect-timeout 5 http://{address}/
      2>/dev/null || true
    timeout: 30
    output_file: '{scandir}/hostname_discovery_http.txt'
  - name: discover_https_hostnames
    condition: check_https
    command: curl -s -I -k --max-time {http_timeout} --connect-timeout 5 https://{address}/
      2>/dev/null || true
    timeout: 30
    output_file: '{scandir}/hostname_discovery_https.txt'
  - name: nmap_hostname_scripts
    command: nmap -T4 -p 80,443,8080,8443 --script=http-server-header,http-title,ssl-cert
      -oN "{scandir}/hostname_nmap.txt" {address}
    timeout: 120
  manual_commands:
  - description: (curl) Check HTTP redirects for hostname
    command: curl -I http://{address}/
  - description: (curl) Check HTTPS certificate for hostname
    command: curl -I -k https://{address}/
  - description: (nmap) Extract hostnames from SSL certificates
    command: nmap -p 443 --script ssl-cert {address}
output:
  patterns:
  - pattern: (?i)Location:\s*https?://([^/\s]+)
    description: 'HTTP Redirect Hostname: {match1}'
    severity: info
    category: hostname
  - pattern: (?i)Server:\s*(.+)
    description: 'Web Server: {match1}'
    severity: info
    category: technology
  - pattern: '(?i)Subject: .+CN=([^,\s]+)'
    description: 'SSL Certificate Hostname: {match1}'
    severity: info
    category: hostname
  - pattern: '(?i)Subject Alternative Name: (.+)'
    description: 'SSL Alternative Names: {match1}'
    severity: info
    category: hostname
  - pattern: (?i)\|\s*([^\|]+)\s*$
    description: 'Web Page Title: {match1}'
    severity: info
    category: information
  - pattern: (?i)(Apache|nginx|IIS).+at ([^\s]+) port
    description: 'Server Error Hostname: {match2}'
    severity: info
    category: hostname
  technology_detection:
  - pattern: '(?i)Server: Apache/([\d\.]+)'
    technology: Apache
    version_group: 1
  - pattern: '(?i)Server: nginx/([\d\.]+)'
    technology: Nginx
    version_group: 1
  - pattern: '(?i)Server: Microsoft-IIS/([\d\.]+)'
    technology: IIS
    version_group: 1
requirements:
  tools:
  - name: curl
    check_command: curl --version
    install_hint: apt-get install curl
  - name: nmap
    check_command: nmap --version
    install_hint: apt-get install nmap
debug:
  log_level: info
  trace_decisions: true
  show_command_output: false
variables:
  http_timeout: 10
