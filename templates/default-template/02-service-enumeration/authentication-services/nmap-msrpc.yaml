metadata:
  name: Nmap MSRPC
  description: Microsoft RPC service enumeration using comprehensive nmap scripts
  type: servicescan
  priority: 5
  version: '1.0'
  author: IPCrawler YAML Plugin System
  tags:
  - default
  - rpc
conditions:
  services:
    include:
    - ^msrpc
    - ^rpcbind
    - ^erpc
options:
- name: min_rate
  type: integer
  default: 5000
  help: Minimum packet rate per second
- name: max_rate
  type: integer
  default: 10000
  help: Maximum packet rate per second
- name: timing_template
  type: choice
  choices:
  - T1
  - T2
  - T3
  - T4
  - T5
  default: T5
  help: Nmap timing template
execution:
  commands:
  - name: nmap_msrpc_enumeration
    command: nmap -{timing_template} --min-rate={min_rate} --max-rate={max_rate}
      -sV -p {port} --script="banner,msrpc-enum,rpc-grind,rpcinfo" -oN "{scandir}/{protocol}_{port}_rpc_nmap.txt"
      -oX "{scandir}/xml/{protocol}_{port}_rpc_nmap.xml" {address}
    timeout: 600
    output_file: '{protocol}_{port}_rpc_nmap.txt'
  manual_commands:
  - description: (nmap) Comprehensive RPC enumeration
    command: nmap -T5 -sV -p {port} --script="msrpc-enum,rpc-grind,rpcinfo" {address}
  - description: (nmap) RPC endpoint mapping
    command: nmap -p {port} --script="rpc-grind" {address}
  - description: (nmap) RPC service information
    command: nmap -p {port} --script="rpcinfo" {address}
  - description: (nmap) MSRPC interface enumeration
    command: nmap -p {port} --script="msrpc-enum" {address}
  - description: (rpcinfo) List all RPC services
    command: rpcinfo -p {address}
  - description: (rpcclient) Connect with null session
    command: rpcclient -p {port} -U "" -N {address}
  - description: (enum4linux) Complete enumeration
    command: enum4linux -a {address}
output:
  patterns:
  - pattern: (?i)rpc.*service.*detected
    description: RPC service detected
    severity: medium
    category: detection
  - pattern: (?i)msrpc.*service
    description: Microsoft RPC service detected
    severity: medium
    category: detection
  - pattern: (?i)endpoint.*mapper.*detected
    description: RPC Endpoint Mapper detected - service enumeration possible
    severity: medium
    category: detection
  - pattern: (?i)rpc.*program[s]?[:\s]*([^\n\r]+)
    description: 'RPC Programs Available: {match1}'
    severity: medium
    category: services
  - pattern: (?i)program.*([\d]+).*version.*([\d\.]+)
    description: RPC Program {match1} Version {match2}
    severity: info
    category: services
  - pattern: (?i)procedure[s]?[:\s]*([^\n\r]+)
    description: 'RPC Procedures: {match1}'
    severity: medium
    category: services
  - pattern: (?i)uuid[:\s]*([a-f0-9\-]+)
    description: 'RPC Interface UUID: {match1}'
    severity: info
    category: interfaces
  - pattern: (?i)interface[:\s]*([^\n\r]+)
    description: 'RPC Interface: {match1}'
    severity: medium
    category: interfaces
  - pattern: (?i)endpoint[s]?[:\s]*([^\n\r]+)
    description: 'RPC Endpoints: {match1}'
    severity: medium
    category: interfaces
  - pattern: (?i)ncacn_ip_tcp[:\s]*([^\n\r]+)
    description: 'TCP RPC Endpoint: {match1}'
    severity: medium
    category: interfaces
  - pattern: (?i)ncacn_np[:\s]*([^\n\r]+)
    description: 'Named Pipe RPC Endpoint: {match1}'
    severity: medium
    category: interfaces
  - pattern: (?i)version[:\s]*([\d\.]+)
    description: 'RPC Service Version: {match1}'
    severity: info
    category: version
  - pattern: (?i)rpc.*version[:\s]*([\d\.]+)
    description: 'RPC Protocol Version: {match1}'
    severity: info
    category: version
  - pattern: (?i)authentication.*level[:\s]*([^\n\r]+)
    description: 'RPC Authentication Level: {match1}'
    severity: info
    category: authentication
  - pattern: (?i)authentication.*service[:\s]*([^\n\r]+)
    description: 'RPC Authentication Service: {match1}'
    severity: info
    category: authentication
  - pattern: (?i)anonymous.*access.*allowed
    description: 'CRITICAL: Anonymous RPC access allowed'
    severity: critical
    category: security
  - pattern: (?i)null.*session.*allowed
    description: 'HIGH: RPC null session allowed'
    severity: high
    category: security
  - pattern: (?i)authentication.*required
    description: RPC authentication required
    severity: info
    category: security
  - pattern: (?i)lsarpc.*interface
    description: LSA RPC interface detected - policy enumeration possible
    severity: medium
    category: interfaces
  - pattern: (?i)samr.*interface
    description: SAM RPC interface detected - user enumeration possible
    severity: medium
    category: interfaces
  - pattern: (?i)srvsvc.*interface
    description: Server Service RPC interface detected - share enumeration possible
    severity: medium
    category: interfaces
  - pattern: (?i)wkssvc.*interface
    description: Workstation Service RPC interface detected
    severity: medium
    category: interfaces
  - pattern: (?i)netlogon.*interface
    description: Netlogon RPC interface detected - domain enumeration possible
    severity: medium
    category: interfaces
  - pattern: (?i)winreg.*interface
    description: Windows Registry RPC interface detected - registry access possible
    severity: high
    category: interfaces
  - pattern: (?i)spoolss.*interface
    description: Print Spooler RPC interface detected
    severity: medium
    category: interfaces
  - pattern: (?i)eventlog.*interface
    description: Event Log RPC interface detected
    severity: medium
    category: interfaces
  - pattern: (?i)drsuapi.*interface
    description: Directory Replication Service RPC interface detected
    severity: medium
    category: interfaces
  - pattern: (?i)dssetup.*interface
    description: Directory Service Setup RPC interface detected
    severity: medium
    category: interfaces
  - pattern: (?i)lsads.*interface
    description: LSA Domain Services RPC interface detected
    severity: medium
    category: interfaces
  - pattern: (?i)service.*name[:\s]*([^\n\r]+)
    description: 'RPC Service Name: {match1}'
    severity: info
    category: services
  - pattern: (?i)service.*description[:\s]*([^\n\r]+)
    description: 'RPC Service Description: {match1}'
    severity: info
    category: services
  - pattern: (?i)protocol.*sequence[:\s]*([^\n\r]+)
    description: 'RPC Protocol Sequence: {match1}'
    severity: info
    category: protocol
  - pattern: (?i)transport.*protocol[:\s]*([^\n\r]+)
    description: 'RPC Transport Protocol: {match1}'
    severity: info
    category: protocol
  - pattern: (?i)tcp.*port[:\s]*([0-9]+)
    description: 'RPC TCP Port: {match1}'
    severity: info
    category: ports
  - pattern: (?i)udp.*port[:\s]*([0-9]+)
    description: 'RPC UDP Port: {match1}'
    severity: info
    category: ports
  - pattern: (?i)named.*pipe[:\s]*([^\n\r]+)
    description: 'RPC Named Pipe: {match1}'
    severity: info
    category: pipes
  - pattern: (?i)access.*denied
    description: RPC access denied
    severity: info
    category: access_control
  - pattern: (?i)invalid.*parameter
    description: RPC invalid parameter
    severity: info
    category: error
  - pattern: (?i)procedure.*not.*found
    description: RPC procedure not found
    severity: info
    category: error
  - pattern: (?i)interface.*not.*found
    description: RPC interface not found
    severity: info
    category: error
  - pattern: (?i)connection.*refused
    description: RPC connection refused
    severity: low
    category: connectivity
  - pattern: (?i)service.*unavailable
    description: RPC service unavailable
    severity: low
    category: availability
  - pattern: (?i)timeout.*exceeded
    description: RPC operation timeout
    severity: low
    category: connectivity
  - pattern: (?i)null.*pointer.*dereference
    description: 'CRITICAL: RPC null pointer dereference vulnerability'
    severity: critical
    category: vulnerability
  - pattern: (?i)buffer.*overflow
    description: 'CRITICAL: RPC buffer overflow vulnerability'
    severity: critical
    category: vulnerability
  - pattern: (?i)remote.*code.*execution
    description: 'CRITICAL: RPC remote code execution vulnerability'
    severity: critical
    category: vulnerability
  - pattern: (?i)privilege.*escalation
    description: 'HIGH: RPC privilege escalation vulnerability'
    severity: high
    category: vulnerability
  - pattern: (?i)server.*name[:\s]*([^\n\r]+)
    description: 'RPC Server Name: {match1}'
    severity: info
    category: server
  - pattern: (?i)server.*version[:\s]*([^\n\r]+)
    description: 'RPC Server Version: {match1}'
    severity: info
    category: server
  - pattern: (?i)server.*comment[:\s]*([^\n\r]+)
    description: 'RPC Server Comment: {match1}'
    severity: info
    category: server
  - pattern: (?i)binding.*handle[:\s]*([^\n\r]+)
    description: 'RPC Binding Handle: {match1}'
    severity: info
    category: binding
  - pattern: (?i)binding.*string[:\s]*([^\n\r]+)
    description: 'RPC Binding String: {match1}'
    severity: info
    category: binding
  technology_detection:
  - pattern: (?i)microsoft.*rpc
    technology: Microsoft RPC
  - pattern: (?i)samba.*([\d\.]+)
    technology: Samba
    version_group: 1
  - pattern: (?i)windows.*server.*([\d]+)
    technology: Windows Server
    version_group: 1
  - pattern: (?i)active.*directory
    technology: Active Directory
  - pattern: (?i)dce.*rpc
    technology: DCE/RPC
requirements:
  tools:
  - name: nmap
    check_command: nmap --version
    install_hint: apt-get install nmap
debug:
  log_level: info
  trace_decisions: false
  show_command_output: false
variables:
  min_rate: 1000
  max_rate: 5000
  timing_template: T4
