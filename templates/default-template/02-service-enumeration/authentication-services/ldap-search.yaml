metadata:
  name: "LDAP Search and Enumeration"
  description: "Comprehensive LDAP enumeration including anonymous binds, user enumeration, and directory structure discovery"
  author: "IPCrawler YAML Plugin System"
  version: "1.0.0"
  type: "servicescan"
  slug: "ldap-search"
  priority: 4
  references:
    - "https://tools.ietf.org/html/rfc4511"
    - "https://ldap.com/"

conditions:
  services_include:
    - "^ldap"
    - "^ldaps"
    - "^domain"
  ports_include:
    - 389
    - 636
    - 3268
    - 3269

commands:
  - description: "LDAP anonymous bind test"
    command: "ldapsearch -x -h {address} -p {port} -s base"
    timeout: 30

  - description: "LDAP base DN discovery"
    command: "ldapsearch -x -h {address} -p {port} -s base -b '' '(objectclass=*)' namingContexts"
    timeout: 30

  - description: "LDAP schema discovery"
    command: "ldapsearch -x -h {address} -p {port} -s base -b '' '(objectclass=*)' subschemaSubentry"
    timeout: 30

  - description: "LDAP user enumeration"
    command: "ldapsearch -x -h {address} -p {port} -b 'dc=domain,dc=local' '(objectclass=person)' sAMAccountName"
    timeout: 60

  - description: "LDAP group enumeration"
    command: "ldapsearch -x -h {address} -p {port} -b 'dc=domain,dc=local' '(objectclass=group)' cn"
    timeout: 60

  - description: "LDAP computer enumeration"
    command: "ldapsearch -x -h {address} -p {port} -b 'dc=domain,dc=local' '(objectclass=computer)' cn"
    timeout: 60

  - description: "LDAP domain admins"
    command: "ldapsearch -x -h {address} -p {port} -b 'dc=domain,dc=local' '(memberof=*admin*)' sAMAccountName"
    timeout: 60

  - description: "LDAP service accounts"
    command: "ldapsearch -x -h {address} -p {port} -b 'dc=domain,dc=local' '(servicePrincipalName=*)' sAMAccountName servicePrincipalName"
    timeout: 60

  - description: "LDAP domain controllers"
    command: "ldapsearch -x -h {address} -p {port} -b 'dc=domain,dc=local' '(primaryGroupID=516)' cn"
    timeout: 30

  - description: "LDAP password policy"
    command: "ldapsearch -x -h {address} -p {port} -b 'dc=domain,dc=local' '(objectclass=domainDNS)' maxPwdAge minPwdAge"
    timeout: 30

patterns:
  - description: "LDAP Server Response"
    pattern: "dn:\\s*$"
    category: "ldap_server"
    severity: "info"

  - description: "LDAP Naming Context"
    pattern: "namingContexts:\\s*(.+)"
    category: "domain_info"
    severity: "medium"

  - description: "LDAP Schema"
    pattern: "subschemaSubentry:\\s*(.+)"
    category: "schema_info"
    severity: "low"

  - description: "LDAP User Account"
    pattern: "sAMAccountName:\\s*(.+)"
    category: "user_account"
    severity: "medium"

  - description: "LDAP Group"
    pattern: "cn:\\s*(.+).*objectClass:\\s*group"
    category: "group"
    severity: "medium"

  - description: "LDAP Computer Account"
    pattern: "cn:\\s*(.+).*objectClass:\\s*computer"
    category: "computer_account"
    severity: "medium"

  - description: "LDAP Domain Admin"
    pattern: "memberOf:.*[Aa]dmin.*sAMAccountName:\\s*(.+)"
    category: "privileged_account"
    severity: "high"

  - description: "LDAP Service Principal Name"
    pattern: "servicePrincipalName:\\s*(.+)"
    category: "service_account"
    severity: "medium"

  - description: "LDAP Domain Controller"
    pattern: "primaryGroupID:\\s*516"
    category: "domain_controller"
    severity: "medium"

  - description: "LDAP Password Policy"
    pattern: "(maxPwdAge|minPwdAge|minPwdLength):\\s*(.+)"
    category: "password_policy"
    severity: "medium"

  - description: "LDAP Anonymous Bind Allowed"
    pattern: "result:\\s*0\\s*Success"
    category: "anonymous_access"
    severity: "medium"

  - description: "LDAP Bind Failure"
    pattern: "result:\\s*([1-9][0-9]*)\\s*(.+)"
    category: "access_denied"
    severity: "low"

  - description: "LDAP Distinguished Name"
    pattern: "dn:\\s*(.+)"
    category: "distinguished_name"
    severity: "info"

  - description: "LDAP Object Class"
    pattern: "objectClass:\\s*(.+)"
    category: "object_type"
    severity: "info"

  - description: "LDAP Mail Attribute"
    pattern: "mail:\\s*(.+@.+)"
    category: "email_address"
    severity: "medium"

  - description: "LDAP Description"
    pattern: "description:\\s*(.+)"
    category: "description"
    severity: "low"

  - description: "LDAP Home Directory"
    pattern: "homeDirectory:\\s*(.+)"
    category: "home_directory"
    severity: "medium"

  - description: "LDAP Login Shell"
    pattern: "loginShell:\\s*(.+)"
    category: "login_shell"
    severity: "medium"

  - description: "LDAP POSIX Account"
    pattern: "objectClass:\\s*posixAccount"
    category: "posix_account"
    severity: "medium"

  - description: "LDAP Group Membership"
    pattern: "memberOf:\\s*(.+)"
    category: "group_membership"
    severity: "medium"

  - description: "LDAP Last Logon"
    pattern: "lastLogon:\\s*(.+)"
    category: "last_logon"
    severity: "medium"

  - description: "LDAP Password Last Set"
    pattern: "pwdLastSet:\\s*(.+)"
    category: "password_age"
    severity: "medium"

  - description: "LDAP Account Control"
    pattern: "userAccountControl:\\s*(.+)"
    category: "account_control"
    severity: "medium"

  - description: "LDAP Kerberos Encryption"
    pattern: "msDS-SupportedEncryptionTypes:\\s*(.+)"
    category: "kerberos_encryption"
    severity: "medium"