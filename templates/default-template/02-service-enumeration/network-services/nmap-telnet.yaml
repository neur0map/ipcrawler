metadata:
  name: "Nmap Telnet"
  description: "Telnet service enumeration with security analysis using nmap scripts"
  type: "servicescan"
  priority: 5
  version: "1.0"
  author: "IPCrawler YAML Plugin System"

conditions:
  services:
    include: ["^telnet"]

options:
  - name: "min_rate"
    type: "integer"
    default: 5000
    help: "Minimum packet rate per second"
  - name: "max_rate"
    type: "integer"
    default: 10000
    help: "Maximum packet rate per second"
  - name: "timing_template"
    type: "choice"
    choices: ["T1", "T2", "T3", "T4", "T5"]
    default: "T5"
    help: "Nmap timing template"

execution:
  commands:
    - name: "nmap_telnet_enumeration"
      command: "nmap {nmap_extra} -{timing_template} --min-rate={min_rate} --max-rate={max_rate} -sV -p {port} --script=\"banner,telnet-encryption,telnet-ntlm-info\" -oN \"{scandir}/{protocol}_{port}_telnet-nmap.txt\" -oX \"{scandir}/xml/{protocol}_{port}_telnet_nmap.xml\" {address}"
      timeout: 600
      output_file: "{protocol}_{port}_telnet-nmap.txt"

  manual_commands:
    - description: "(nmap) Telnet enumeration with comprehensive scripts"
      command: "nmap -sV -p {port} --script=\"telnet*\" {address}"
    - description: "(nmap) Telnet encryption and authentication analysis"
      command: "nmap -p {port} --script telnet-encryption,telnet-ntlm-info {address}"
    - description: "(telnet) Connect to Telnet service"
      command: "telnet {address} {port}"

output:
  patterns:
    # Telnet Version Detection
    - pattern: "(?i)telnet.*version[:\\s]*([^\\n\\r]+)"
      description: "Telnet Version: {match1}"
      severity: "info"
      category: "version"
    
    - pattern: "(?i)protocol.*version[:\\s]*([^\\n\\r]+)"
      description: "Telnet Protocol Version: {match1}"
      severity: "info"
      category: "version"
    
    # Encryption Analysis
    - pattern: "(?i)encryption.*enabled"
      description: "Telnet encryption enabled"
      severity: "info"
      category: "security"
    
    - pattern: "(?i)encryption.*disabled"
      description: "CRITICAL: Telnet encryption disabled - plaintext communication"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)no.*encryption"
      description: "CRITICAL: Telnet no encryption - all traffic sent in plaintext"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)ssl.*encryption"
      description: "Telnet SSL encryption detected"
      severity: "info"
      category: "security"
    
    - pattern: "(?i)tls.*encryption"
      description: "Telnet TLS encryption detected"
      severity: "info"
      category: "security"
    
    # Authentication Methods
    - pattern: "(?i)ntlm.*authentication"
      description: "Telnet NTLM authentication detected"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)kerberos.*authentication"
      description: "Telnet Kerberos authentication detected"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)authentication.*methods[:\\s]*([^\\n\\r]+)"
      description: "Telnet Authentication Methods: {match1}"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)password.*authentication"
      description: "Telnet password authentication enabled"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)no.*authentication"
      description: "CRITICAL: Telnet no authentication required - open access"
      severity: "critical"
      category: "security"
    
    # Server Information
    - pattern: "(?i)server.*name[:\\s]*([^\\n\\r]+)"
      description: "Telnet Server Name: {match1}"
      severity: "info"
      category: "server"
    
    - pattern: "(?i)server.*version[:\\s]*([^\\n\\r]+)"
      description: "Telnet Server Version: {match1}"
      severity: "info"
      category: "server"
    
    - pattern: "(?i)operating.*system[:\\s]*([^\\n\\r]+)"
      description: "Operating System: {match1}"
      severity: "info"
      category: "system"
    
    - pattern: "(?i)system.*type[:\\s]*([^\\n\\r]+)"
      description: "System Type: {match1}"
      severity: "info"
      category: "system"
    
    # Banner Information
    - pattern: "(?i)banner[:\\s]*([^\\n\\r]+)"
      description: "Telnet Banner: {match1}"
      severity: "info"
      category: "banner"
    
    - pattern: "(?i)welcome.*message[:\\s]*([^\\n\\r]+)"
      description: "Telnet Welcome Message: {match1}"
      severity: "info"
      category: "banner"
    
    - pattern: "(?i)login.*prompt[:\\s]*([^\\n\\r]+)"
      description: "Telnet Login Prompt: {match1}"
      severity: "info"
      category: "banner"
    
    # NTLM Information
    - pattern: "(?i)ntlm.*domain[:\\s]*([^\\n\\r]+)"
      description: "NTLM Domain: {match1}"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)ntlm.*workstation[:\\s]*([^\\n\\r]+)"
      description: "NTLM Workstation: {match1}"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)ntlm.*target.*name[:\\s]*([^\\n\\r]+)"
      description: "NTLM Target Name: {match1}"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)ntlm.*dns.*computer.*name[:\\s]*([^\\n\\r]+)"
      description: "NTLM DNS Computer Name: {match1}"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)ntlm.*dns.*domain.*name[:\\s]*([^\\n\\r]+)"
      description: "NTLM DNS Domain Name: {match1}"
      severity: "info"
      category: "authentication"
    
    # Security Configuration
    - pattern: "(?i)root.*login.*enabled"
      description: "CRITICAL: Telnet root login enabled"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)root.*login.*disabled"
      description: "Telnet root login disabled - good security practice"
      severity: "info"
      category: "security"
    
    - pattern: "(?i)anonymous.*login.*enabled"
      description: "CRITICAL: Telnet anonymous login enabled"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)guest.*login.*enabled"
      description: "HIGH: Telnet guest login enabled"
      severity: "high"
      category: "security"
    
    # Connection Information
    - pattern: "(?i)connection.*established"
      description: "Telnet connection established successfully"
      severity: "info"
      category: "connection"
    
    - pattern: "(?i)connection.*refused"
      description: "Telnet connection refused"
      severity: "info"
      category: "connection"
    
    - pattern: "(?i)connection.*timeout"
      description: "Telnet connection timeout"
      severity: "info"
      category: "connection"
    
    # Protocol Options
    - pattern: "(?i)terminal.*type[:\\s]*([^\\n\\r]+)"
      description: "Telnet Terminal Type: {match1}"
      severity: "info"
      category: "protocol"
    
    - pattern: "(?i)window.*size[:\\s]*([^\\n\\r]+)"
      description: "Telnet Window Size: {match1}"
      severity: "info"
      category: "protocol"
    
    - pattern: "(?i)negotiation.*options[:\\s]*([^\\n\\r]+)"
      description: "Telnet Negotiation Options: {match1}"
      severity: "info"
      category: "protocol"
    
    # Specific Telnet Implementations
    - pattern: "(?i)cisco.*telnet"
      description: "Cisco Telnet service detected"
      severity: "info"
      category: "implementation"
    
    - pattern: "(?i)juniper.*telnet"
      description: "Juniper Telnet service detected"
      severity: "info"
      category: "implementation"
    
    - pattern: "(?i)windows.*telnet"
      description: "Windows Telnet service detected"
      severity: "info"
      category: "implementation"
    
    - pattern: "(?i)linux.*telnet"
      description: "Linux Telnet service detected"
      severity: "info"
      category: "implementation"
    
    # Error Conditions
    - pattern: "(?i)handshake.*failed"
      description: "Telnet handshake failed"
      severity: "info"
      category: "error"
    
    - pattern: "(?i)protocol.*error"
      description: "Telnet protocol error"
      severity: "info"
      category: "error"
    
    - pattern: "(?i)authentication.*failed"
      description: "Telnet authentication failed"
      severity: "info"
      category: "error"
    
    # Command Execution Warnings
    - pattern: "(?i)command.*execution.*enabled"
      description: "WARNING: Telnet command execution enabled - potential security risk"
      severity: "medium"
      category: "security"
    
    - pattern: "(?i)shell.*access.*enabled"
      description: "WARNING: Telnet shell access enabled - potential security risk"
      severity: "medium"
      category: "security"

  technology_detection:
    - pattern: "(?i)cisco.*ios\\s+([\\d\\.]+)"
      technology: "Cisco IOS"
      version_group: 1
    
    - pattern: "(?i)junos\\s+([\\d\\.]+)"
      technology: "Juniper JUNOS"
      version_group: 1
    
    - pattern: "(?i)windows.*server\\s+([\\d\\.]+)"
      technology: "Windows Server"
      version_group: 1
    
    - pattern: "(?i)linux\\s+([\\d\\.]+)"
      technology: "Linux"
      version_group: 1
    
    - pattern: "(?i)telnet\\s+([\\d\\.]+)"
      technology: "Telnet"
      version_group: 1

requirements:
  tools:
    - name: "nmap"
      check_command: "nmap --version"
      install_hint: "apt-get install nmap"

debug:
  log_level: "info"
  trace_decisions: false
  show_command_output: false