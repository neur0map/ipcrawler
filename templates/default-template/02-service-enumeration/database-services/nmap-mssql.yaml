metadata:
  name: Nmap MSSQL Enumeration
  description: Microsoft SQL Server enumeration using comprehensive nmap scripts
  type: servicescan
  priority: 5
  version: '1.0'
  author: IPCrawler YAML Plugin System
conditions:
  services:
    include:
    - ^mssql
    - ^ms-sql
options:
- name: min_rate
  type: integer
  default: 5000
  help: Minimum packet rate per second
- name: max_rate
  type: integer
  default: 10000
  help: Maximum packet rate per second
- name: timing_template
  type: choice
  choices:
  - T1
  - T2
  - T3
  - T4
  - T5
  default: T5
  help: Nmap timing template
execution:
  commands:
  - name: nmap_mssql_enumeration
    command: nmap -{timing_template} --min-rate={min_rate} --max-rate={max_rate}
      -sV -p {port} --script="banner,(ms-sql* or ssl*) and not (brute or broadcast
      or dos or external or fuzzer)" --script-args="mssql.instance-port={port},mssql.username=sa,mssql.password=sa"
      -oN "{scandir}/{protocol}_{port}_mssql_nmap.txt" -oX "{scandir}/xml/{protocol}_{port}_mssql_nmap.xml"
      {address}
    timeout: 600
    output_file: '{protocol}_{port}_mssql_nmap.txt'
  manual_commands:
  - description: (nmap) MSSQL enumeration with scripts
    command: nmap -T5 -sV -p {port} --script="ms-sql*" {address}
  - description: (nmap) MSSQL info and configuration
    command: nmap -p {port} --script ms-sql-info,ms-sql-config {address}
  - description: (sqsh) Interactive database shell
    command: sqsh -U <username> -P <password> -S {address}:{port}
  - description: (sqlcmd) Microsoft SQL client
    command: sqlcmd -S {address},{port} -U <username> -P <password>
output:
  patterns:
  - pattern: (?i)mssql.*version[:\s]*([^\n\r]+)
    description: 'MSSQL Version: {match1}'
    severity: info
    category: version
  - pattern: (?i)microsoft.*sql.*server.*([\d\.]+)
    description: Microsoft SQL Server v{match1} detected
    severity: info
    category: technology
  - pattern: (?i)sql.*server.*([0-9]{4})
    description: SQL Server {match1} detected - check for known vulnerabilities
    severity: info
    category: technology
  - pattern: (?i)database[s]?[:\s]*([^\n\r]+)
    description: 'MSSQL Databases: {match1}'
    severity: medium
    category: enumeration
  - pattern: (?i)instance.*name[:\s]*([^\n\r]+)
    description: 'MSSQL Instance Name: {match1}'
    severity: info
    category: identification
  - pattern: (?i)server.*name[:\s]*([^\n\r]+)
    description: 'MSSQL Server Name: {match1}'
    severity: info
    category: identification
  - pattern: (?i)computer.*name[:\s]*([^\n\r]+)
    description: 'MSSQL Computer Name: {match1}'
    severity: info
    category: identification
  - pattern: (?i)sa.*login.*enabled
    description: 'CRITICAL: MSSQL SA account enabled'
    severity: critical
    category: security
  - pattern: (?i)sa.*account.*disabled
    description: MSSQL SA account disabled - good security practice
    severity: info
    category: security
  - pattern: (?i)empty.*password.*detected
    description: 'CRITICAL: MSSQL user with empty password detected'
    severity: critical
    category: security
  - pattern: (?i)weak.*password.*detected
    description: 'HIGH: MSSQL weak password detected'
    severity: high
    category: security
  - pattern: (?i)windows.*authentication.*enabled
    description: MSSQL Windows authentication enabled
    severity: info
    category: authentication
  - pattern: (?i)sql.*authentication.*enabled
    description: MSSQL SQL authentication enabled
    severity: info
    category: authentication
  - pattern: (?i)xp_cmdshell.*enabled
    description: 'CRITICAL: MSSQL xp_cmdshell enabled - command execution possible'
    severity: critical
    category: security
  - pattern: (?i)xp_cmdshell.*disabled
    description: MSSQL xp_cmdshell disabled - good security practice
    severity: info
    category: security
  - pattern: (?i)sysadmin.*privileges.*detected
    description: 'CRITICAL: MSSQL sysadmin privileges detected'
    severity: critical
    category: security
  - pattern: (?i)db_owner.*privileges.*detected
    description: 'HIGH: MSSQL db_owner privileges detected'
    severity: high
    category: security
  - pattern: (?i)tcp.*port[:\s]*([0-9]+)
    description: 'MSSQL TCP Port: {match1}'
    severity: info
    category: network
  - pattern: (?i)named.*pipes.*enabled
    description: MSSQL Named Pipes enabled
    severity: info
    category: network
  - pattern: (?i)ssl.*encryption.*enabled
    description: MSSQL SSL encryption enabled - secure connections supported
    severity: info
    category: security
  - pattern: (?i)ssl.*encryption.*disabled
    description: 'WARNING: MSSQL SSL encryption disabled'
    severity: medium
    category: security
  - pattern: (?i)service.*account[:\s]*([^\n\r]+)
    description: 'MSSQL Service Account: {match1}'
    severity: medium
    category: configuration
  - pattern: (?i)clustered.*instance
    description: MSSQL Clustered Instance detected
    severity: info
    category: configuration
  - pattern: (?i)default.*instance
    description: MSSQL Default Instance detected
    severity: info
    category: configuration
  - pattern: (?i)named.*instance[:\s]*([^\n\r]+)
    description: 'MSSQL Named Instance: {match1}'
    severity: info
    category: configuration
  - pattern: (?i)sp_configure.*accessible
    description: MSSQL sp_configure accessible - configuration changes possible
    severity: medium
    category: security
  - pattern: (?i)openrowset.*enabled
    description: 'HIGH: MSSQL OPENROWSET enabled - potential data access'
    severity: high
    category: security
  - pattern: (?i)ole.*automation.*enabled
    description: 'HIGH: MSSQL OLE Automation enabled - potential code execution'
    severity: high
    category: security
  - pattern: (?i)login.*failed.*for.*user
    description: MSSQL login failed - authentication required
    severity: info
    category: authentication
  - pattern: (?i)server.*is.*unavailable
    description: MSSQL server unavailable
    severity: low
    category: availability
  - pattern: (?i)timeout.*expired
    description: MSSQL connection timeout
    severity: low
    category: availability
  - pattern: (?i)sql.*server.*2000
    description: 'CRITICAL: SQL Server 2000 detected - end-of-life, multiple vulnerabilities'
    severity: critical
    category: vulnerability
  - pattern: (?i)sql.*server.*2005
    description: 'HIGH: SQL Server 2005 detected - end-of-life, security risks'
    severity: high
    category: vulnerability
  - pattern: (?i)sql.*server.*2008
    description: 'MEDIUM: SQL Server 2008 detected - end-of-life approaching'
    severity: medium
    category: vulnerability
  - pattern: (?i)injection.*vulnerability.*detected
    description: 'CRITICAL: SQL injection vulnerability detected'
    severity: critical
    category: vulnerability
  - pattern: (?i)backup.*location[:\s]*([^\n\r]+)
    description: 'MSSQL Backup Location: {match1}'
    severity: low
    category: configuration
  - pattern: (?i)backup.*files.*accessible
    description: MSSQL backup files accessible - potential data exposure
    severity: medium
    category: data_exposure
  - pattern: (?i)linked.*server[s]?[:\s]*([^\n\r]+)
    description: 'MSSQL Linked Servers: {match1} - potential lateral movement'
    severity: medium
    category: enumeration
  - pattern: (?i)database.*mail.*enabled
    description: MSSQL Database Mail enabled
    severity: info
    category: configuration
  - pattern: (?i)sql.*agent.*running
    description: MSSQL Agent running - job scheduling available
    severity: info
    category: service
  technology_detection:
  - pattern: (?i)microsoft.*sql.*server.*([\d\.]+)
    technology: Microsoft SQL Server
    version_group: 1
  - pattern: (?i)sql.*server.*([0-9]{4})
    technology: SQL Server
    version_group: 1
  - pattern: (?i)mssql.*([\d\.]+)
    technology: MSSQL
    version_group: 1
requirements:
  tools:
  - name: nmap
    check_command: nmap --version
    install_hint: apt-get install nmap
debug:
  log_level: info
  trace_decisions: false
  show_command_output: false
variables:
  min_rate: 1000
  max_rate: 5000
  timing_template: T4
