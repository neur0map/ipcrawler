metadata:
  name: Nmap MongoDB Enumeration
  description: MongoDB database enumeration using comprehensive nmap scripts
  type: servicescan
  priority: 5
  version: '1.0'
  author: IPCrawler YAML Plugin System
  tags:
  - default
  - safe
  - databases
conditions:
  services:
    include:
    - ^mongod
options:
- name: min_rate
  type: integer
  default: 5000
  help: Minimum packet rate per second
- name: max_rate
  type: integer
  default: 10000
  help: Maximum packet rate per second
- name: timing_template
  type: choice
  choices:
  - T1
  - T2
  - T3
  - T4
  - T5
  default: T5
  help: Nmap timing template
execution:
  commands:
  - name: nmap_mongodb_enumeration
    command: nmap -{timing_template} --min-rate={min_rate} --max-rate={max_rate}
      -sV -p {port} --script="banner,(mongodb* or ssl*) and not (brute or broadcast
      or dos or external or fuzzer)" -oN "{scandir}/{protocol}_{port}_mongodb_nmap.txt"
      -oX "{scandir}/xml/{protocol}_{port}_mongodb_nmap.xml" {address}
    timeout: 600
    output_file: '{protocol}_{port}_mongodb_nmap.txt'
  manual_commands:
  - description: (nmap) MongoDB enumeration with scripts
    command: nmap -T5 -sV -p {port} --script="mongodb*" {address}
  - description: (nmap) MongoDB info and databases
    command: nmap -p {port} --script mongodb-info,mongodb-databases {address}
  - description: (mongo) MongoDB shell client
    command: mongo {address}:{port}
  - description: (mongosh) MongoDB shell (modern client)
    command: mongosh mongodb://{address}:{port}
  - description: (mongostat) MongoDB statistics
    command: mongostat --host {address}:{port}
output:
  patterns:
  - pattern: (?i)mongodb.*version[:\s]*([^\n\r]+)
    description: 'MongoDB Version: {match1}'
    severity: info
    category: version
  - pattern: (?i)mongodb.*([\d\.]+)
    description: MongoDB v{match1} detected
    severity: info
    category: technology
  - pattern: (?i)mongo.*server.*([\d\.]+)
    description: MongoDB Server v{match1} detected
    severity: info
    category: technology
  - pattern: (?i)database[s]?[:\s]*([^\n\r]+)
    description: 'MongoDB Databases: {match1}'
    severity: medium
    category: enumeration
  - pattern: (?i)collection[s]?[:\s]*([^\n\r]+)
    description: 'MongoDB Collections: {match1}'
    severity: medium
    category: enumeration
  - pattern: (?i)document[s]?.*count[:\s]*([^\n\r]+)
    description: 'MongoDB Document Count: {match1}'
    severity: info
    category: statistics
  - pattern: (?i)no.*auth.*required
    description: 'CRITICAL: MongoDB authentication disabled'
    severity: critical
    category: security
  - pattern: (?i)authentication.*enabled
    description: MongoDB authentication enabled
    severity: info
    category: security
  - pattern: (?i)authorization.*enabled
    description: MongoDB authorization enabled
    severity: info
    category: security
  - pattern: (?i)authentication.*disabled
    description: 'CRITICAL: MongoDB authentication disabled'
    severity: critical
    category: security
  - pattern: (?i)default.*credentials.*found
    description: 'CRITICAL: MongoDB default credentials detected'
    severity: critical
    category: security
  - pattern: (?i)empty.*password.*detected
    description: 'CRITICAL: MongoDB empty password detected'
    severity: critical
    category: security
  - pattern: (?i)ssl.*enabled
    description: MongoDB SSL/TLS enabled - encrypted connections supported
    severity: info
    category: security
  - pattern: (?i)ssl.*disabled
    description: 'WARNING: MongoDB SSL/TLS disabled - unencrypted connections'
    severity: medium
    category: security
  - pattern: (?i)tls.*enabled
    description: MongoDB TLS enabled - encrypted connections supported
    severity: info
    category: security
  - pattern: (?i)bind.*ip[:\s]*([^\n\r]+)
    description: 'MongoDB Bind IP: {match1}'
    severity: info
    category: network
  - pattern: (?i)port[:\s]*([^\n\r]+)
    description: 'MongoDB Port: {match1}'
    severity: info
    category: network
  - pattern: (?i)storage.*engine[:\s]*([^\n\r]+)
    description: 'MongoDB Storage Engine: {match1}'
    severity: info
    category: configuration
  - pattern: (?i)wired.*tiger.*enabled
    description: MongoDB WiredTiger storage engine enabled
    severity: info
    category: configuration
  - pattern: (?i)mmapv1.*enabled
    description: MongoDB MMAPv1 storage engine enabled
    severity: info
    category: configuration
  - pattern: (?i)user[s]?[:\s]*([^\n\r]+)
    description: 'MongoDB Users: {match1}'
    severity: high
    category: enumeration
  - pattern: (?i)role[s]?[:\s]*([^\n\r]+)
    description: 'MongoDB Roles: {match1}'
    severity: medium
    category: enumeration
  - pattern: (?i)admin.*user.*found
    description: MongoDB admin user detected
    severity: medium
    category: enumeration
  - pattern: (?i)root.*user.*found
    description: MongoDB root user detected
    severity: medium
    category: enumeration
  - pattern: (?i)replica.*set[:\s]*([^\n\r]+)
    description: 'MongoDB Replica Set: {match1}'
    severity: info
    category: configuration
  - pattern: (?i)shard.*enabled
    description: MongoDB sharding enabled
    severity: info
    category: configuration
  - pattern: (?i)config.*server.*detected
    description: MongoDB config server detected
    severity: info
    category: configuration
  - pattern: (?i)mongos.*detected
    description: MongoDB mongos (shard router) detected
    severity: info
    category: configuration
  - pattern: (?i)uptime[:\s]*([^\n\r]+)
    description: 'MongoDB Uptime: {match1}'
    severity: info
    category: statistics
  - pattern: (?i)connections[:\s]*([^\n\r]+)
    description: 'MongoDB Connections: {match1}'
    severity: info
    category: statistics
  - pattern: (?i)memory.*usage[:\s]*([^\n\r]+)
    description: 'MongoDB Memory Usage: {match1}'
    severity: info
    category: performance
  - pattern: (?i)opcounters[:\s]*([^\n\r]+)
    description: 'MongoDB Operation Counters: {match1}'
    severity: info
    category: statistics
  - pattern: (?i)mongodb.*2\.[0-6]\.
    description: 'CRITICAL: MongoDB 2.x detected - multiple known vulnerabilities'
    severity: critical
    category: vulnerability
  - pattern: (?i)mongodb.*3\.[0-2]\.
    description: 'HIGH: MongoDB 3.0-3.2 detected - known vulnerabilities'
    severity: high
    category: vulnerability
  - pattern: (?i)mongodb.*3\.[4-6]\.
    description: 'MEDIUM: MongoDB 3.4-3.6 detected - check for patches'
    severity: medium
    category: vulnerability
  - pattern: (?i)javascript.*execution.*enabled
    description: 'MEDIUM: MongoDB JavaScript execution enabled - potential security
      risk'
    severity: medium
    category: security
  - pattern: (?i)connection.*refused
    description: MongoDB connection refused
    severity: info
    category: network
  - pattern: (?i)authentication.*failed
    description: MongoDB authentication failed
    severity: info
    category: authentication
  - pattern: (?i)unauthorized
    description: MongoDB unauthorized access attempt
    severity: info
    category: authentication
  - pattern: (?i)command.*not.*found
    description: MongoDB command not found or not allowed
    severity: info
    category: error
  - pattern: (?i)gridfs.*enabled
    description: MongoDB GridFS file storage enabled
    severity: info
    category: configuration
  - pattern: (?i)gridfs.*files.*found
    description: MongoDB GridFS files detected
    severity: medium
    category: enumeration
  - pattern: (?i)backup.*file.*found
    description: MongoDB backup file detected - potential data exposure
    severity: medium
    category: data_exposure
  - pattern: (?i)mongodump.*accessible
    description: MongoDB dump utility accessible
    severity: medium
    category: tools
  - pattern: (?i)oplog.*accessible
    description: MongoDB oplog accessible - potential data exposure
    severity: medium
    category: data_exposure
  - pattern: (?i)index[es]*[:\s]*([^\n\r]+)
    description: 'MongoDB Indexes: {match1}'
    severity: info
    category: configuration
  - pattern: (?i)slow.*query.*detected
    description: MongoDB slow query detected
    severity: low
    category: performance
  - pattern: (?i)listening.*on.*0\.0\.0\.0
    description: 'WARNING: MongoDB listening on all interfaces'
    severity: medium
    category: security
  - pattern: (?i)listening.*on.*127\.0\.0\.1
    description: MongoDB listening on localhost only
    severity: info
    category: security
  technology_detection:
  - pattern: (?i)mongodb.*([\d\.]+)
    technology: MongoDB
    version_group: 1
  - pattern: (?i)mongo.*server.*([\d\.]+)
    technology: MongoDB
    version_group: 1
requirements:
  tools:
  - name: nmap
    check_command: nmap --version
    install_hint: apt-get install nmap
debug:
  log_level: info
  trace_decisions: false
  show_command_output: false
variables:
  min_rate: 1000
  max_rate: 5000
  timing_template: T4
