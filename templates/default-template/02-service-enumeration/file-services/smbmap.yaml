metadata:
  name: "SMBMap Share Enumeration"
  description: "SMB share enumeration and permission analysis using smbmap"
  type: "servicescan"
  priority: 10
  version: "1.0"
  author: "IPCrawler YAML Plugin System"

conditions:
  services:
    include: ["^smb", "^microsoft-ds", "^netbios"]
  when:
    ip_version: ["IPv4"]

options:
  - name: "timeout"
    type: "integer"
    default: 300
    help: "Command timeout in seconds"

execution:
  commands:
    - name: "smbmap_authenticated_shares"
      command: "smbmap -H {address} -P {port} 2>&1"
      timeout: 300
      output_file: "smbmap-share-permissions.txt"
    
    - name: "smbmap_null_session_shares"
      command: "smbmap -u null -p \"\" -H {address} -P {port} 2>&1"
      timeout: 300
      output_file: "smbmap-share-permissions.txt"
    
    - name: "smbmap_authenticated_listing"
      command: "smbmap -H {address} -P {port} -r 2>&1"
      timeout: 300
      output_file: "smbmap-list-contents.txt"
    
    - name: "smbmap_null_session_listing"
      command: "smbmap -u null -p \"\" -H {address} -P {port} -r 2>&1"
      timeout: 300
      output_file: "smbmap-list-contents.txt"
    
    - name: "smbmap_authenticated_command"
      command: "smbmap -H {address} -P {port} -x \"ipconfig /all\" 2>&1"
      timeout: 300
      output_file: "smbmap-execute-command.txt"
    
    - name: "smbmap_null_session_command"
      command: "smbmap -u null -p \"\" -H {address} -P {port} -x \"ipconfig /all\" 2>&1"
      timeout: 300
      output_file: "smbmap-execute-command.txt"

  manual_commands:
    - description: "(smbmap) List shares with permissions"
      command: "smbmap -H {address} -P {port}"
    - description: "(smbmap) List shares with null session"
      command: "smbmap -u null -p '' -H {address} -P {port}"
    - description: "(smbmap) List contents recursively"
      command: "smbmap -H {address} -P {port} -r"
    - description: "(smbmap) Execute command via SMB"
      command: "smbmap -H {address} -P {port} -x 'whoami'"
    - description: "(smbmap) Download file"
      command: "smbmap -H {address} -P {port} --download 'sharename\\filename'"
    - description: "(smbmap) Upload file"
      command: "smbmap -H {address} -P {port} --upload '/local/file' 'sharename\\filename'"

output:
  patterns:
    # Share Access Permissions
    - pattern: "(?i)\\[\\+\\]\\s+([^\\s]+)\\s+(READ|WRITE|READ,WRITE|NO ACCESS)"
      description: "SMB Share Access: {match1} - {match2}"
      severity: "info"
      category: "shares"
    
    - pattern: "(?i)\\[\\+\\]\\s+([^\\s]+)\\s+READ,WRITE"
      description: "SMB Share with WRITE access: {match1}"
      severity: "medium"
      category: "shares"
    
    - pattern: "(?i)\\[\\+\\]\\s+([^\\s]+)\\s+WRITE"
      description: "SMB Share with WRITE access: {match1}"
      severity: "medium"
      category: "shares"
    
    # Administrative and System Shares
    - pattern: "(?i)\\[\\+\\]\\s+(ADMIN\\$|C\\$|IPC\\$)\\s+(READ|write|read,write)"
      description: "Administrative Share Access: {match1} - {match2}"
      severity: "high"
      category: "shares"
    
    - pattern: "(?i)\\[\\+\\]\\s+ADMIN\\$"
      description: "CRITICAL: Administrative share ADMIN$ accessible"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)\\[\\+\\]\\s+C\\$"
      description: "HIGH: System drive share C$ accessible"
      severity: "high"
      category: "security"
    
    - pattern: "(?i)\\[\\+\\]\\s+IPC\\$"
      description: "IPC share accessible - inter-process communication"
      severity: "info"
      category: "shares"
    
    # File and Directory Enumeration
    - pattern: "(?i)\\[\\+\\]\\s+\\.\\.\\s+([^\\n\\r]+)"
      description: "Directory enumeration: {match1}"
      severity: "info"
      category: "enumeration"
    
    - pattern: "(?i)\\[\\+\\]\\s+([^\\s]+\\.(txt|doc|docx|pdf|xls|xlsx|ppt|pptx|config|conf|xml|json|sql|bak|backup))"
      description: "Interesting file found: {match1}"
      severity: "medium"
      category: "files"
    
    - pattern: "(?i)\\[\\+\\]\\s+([^\\s]+\\.(key|pem|crt|p12|pfx|jks|keystore))"
      description: "Certificate/Key file found: {match1}"
      severity: "high"
      category: "files"
    
    - pattern: "(?i)\\[\\+\\]\\s+([^\\s]+\\.(password|passwd|pwd|secret|credential))"
      description: "Password/Credential file found: {match1}"
      severity: "high"
      category: "files"
    
    # Authentication and Access
    - pattern: "(?i)\\[\\+\\].*null.*session"
      description: "SMB null session access successful"
      severity: "high"
      category: "security"
    
    - pattern: "(?i)\\[\\+\\].*guest.*access"
      description: "SMB guest access successful"
      severity: "medium"
      category: "security"
    
    - pattern: "(?i)\\[\\+\\].*anonymous.*access"
      description: "SMB anonymous access successful"
      severity: "high"
      category: "security"
    
    # Command Execution
    - pattern: "(?i)\\[\\+\\].*command.*executed"
      description: "SMB command execution successful"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)\\[\\+\\].*executing.*command"
      description: "SMB command execution attempted"
      severity: "high"
      category: "security"
    
    # Error Patterns
    - pattern: "(?i)\\[\\-\\].*access.*denied"
      description: "SMB access denied"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)\\[\\-\\].*authentication.*failed"
      description: "SMB authentication failed"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)\\[\\-\\].*connection.*failed"
      description: "SMB connection failed"
      severity: "info"
      category: "connectivity"
    
    # Share Types and Information
    - pattern: "(?i)\\[\\+\\]\\s+([^\\s]+)\\s+.*disk.*"
      description: "SMB Disk Share: {match1}"
      severity: "info"
      category: "shares"
    
    - pattern: "(?i)\\[\\+\\]\\s+([^\\s]+)\\s+.*printer.*"
      description: "SMB Printer Share: {match1}"
      severity: "info"
      category: "shares"
    
    - pattern: "(?i)\\[\\+\\]\\s+([^\\s]+)\\s+.*pipe.*"
      description: "SMB Named Pipe: {match1}"
      severity: "info"
      category: "shares"
    
    # Domain and System Information
    - pattern: "(?i)\\[\\+\\].*domain[:\\s]*([^\\n\\r]+)"
      description: "SMB Domain: {match1}"
      severity: "info"
      category: "identification"
    
    - pattern: "(?i)\\[\\+\\].*workgroup[:\\s]*([^\\n\\r]+)"
      description: "SMB Workgroup: {match1}"
      severity: "info"
      category: "identification"
    
    - pattern: "(?i)\\[\\+\\].*server[:\\s]*([^\\n\\r]+)"
      description: "SMB Server: {match1}"
      severity: "info"
      category: "identification"
    
    # File Content Analysis
    - pattern: "(?i)password[:\\s]*([^\\n\\r]+)"
      description: "Password found in file: {match1}"
      severity: "critical"
      category: "credentials"
    
    - pattern: "(?i)username[:\\s]*([^\\n\\r]+)"
      description: "Username found in file: {match1}"
      severity: "medium"
      category: "credentials"
    
    - pattern: "(?i)api[_\\s]*key[:\\s]*([^\\n\\r]+)"
      description: "API key found in file: {match1}"
      severity: "high"
      category: "credentials"

  technology_detection:
    - pattern: "(?i)windows.*server.*([0-9]{4})"
      technology: "Windows Server"
      version_group: 1
    
    - pattern: "(?i)windows.*(7|8|10|11)"
      technology: "Windows Desktop"
      version_group: 1
    
    - pattern: "(?i)samba.*([0-9]+\\.[0-9]+)"
      technology: "Samba"
      version_group: 1

requirements:
  tools:
    - name: "smbmap"
      check_command: "smbmap --help"
      install_hint: "pip install smbmap"

debug:
  log_level: "info"
  trace_decisions: false
  show_command_output: false