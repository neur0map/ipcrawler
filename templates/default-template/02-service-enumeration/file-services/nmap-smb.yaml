metadata:
  name: "Nmap SMB Enumeration"
  description: "SMB service enumeration using comprehensive nmap scripts"
  type: "servicescan"
  priority: 5
  version: "1.0"
  author: "IPCrawler YAML Plugin System"

conditions:
  services:
    include: ["^smb", "^microsoft-ds", "^netbios"]

options:
  - name: "min_rate"
    type: "integer"
    default: 5000
    help: "Minimum packet rate per second"
  - name: "max_rate"
    type: "integer"
    default: 10000
    help: "Maximum packet rate per second"
  - name: "timing_template"
    type: "choice"
    choices: ["T1", "T2", "T3", "T4", "T5"]
    default: "T5"
    help: "Nmap timing template"

execution:
  commands:
    - name: "nmap_smb_enumeration"
      command: "nmap {nmap_extra} -{timing_template} --min-rate={min_rate} --max-rate={max_rate} -sV -p {port} --script=\"banner,(nbstat or smb* or ssl*) and not (brute or broadcast or dos or external or fuzzer)\" -oN \"{scandir}/{protocol}_{port}_smb_nmap.txt\" -oX \"{scandir}/xml/{protocol}_{port}_smb_nmap.xml\" {address}"
      timeout: 600
      output_file: "{protocol}_{port}_smb_nmap.txt"

  manual_commands:
    - description: "(nmap) SMB enumeration with scripts"
      command: "nmap -T5 -sV -p {port} --script=\"smb*\" {address}"
    - description: "(nmap) SMB version and OS detection"
      command: "nmap -p {port} --script smb-os-discovery,smb-protocols {address}"
    - description: "(nmap) SMB shares enumeration"
      command: "nmap -p {port} --script smb-enum-shares {address}"

output:
  patterns:
    # SMB Version and OS Detection
    - pattern: "(?i)smb.*version[:\\s]*([^\\n\\r]+)"
      description: "SMB Version: {match1}"
      severity: "info"
      category: "version"
    
    - pattern: "(?i)os[:\\s]*([^\\n\\r]+)"
      description: "SMB OS Information: {match1}"
      severity: "info"
      category: "os_detection"
    
    - pattern: "(?i)computer name[:\\s]*([^\\n\\r]+)"
      description: "SMB Computer Name: {match1}"
      severity: "info"
      category: "identification"
    
    - pattern: "(?i)netbios computer name[:\\s]*([^\\n\\r]+)"
      description: "NetBIOS Computer Name: {match1}"
      severity: "info"
      category: "identification"
    
    - pattern: "(?i)domain name[:\\s]*([^\\n\\r]+)"
      description: "SMB Domain Name: {match1}"
      severity: "info"
      category: "identification"
    
    - pattern: "(?i)forest name[:\\s]*([^\\n\\r]+)"
      description: "Active Directory Forest: {match1}"
      severity: "info"
      category: "identification"
    
    - pattern: "(?i)workgroup[:\\s]*([^\\n\\r]+)"
      description: "SMB Workgroup: {match1}"
      severity: "info"
      category: "identification"
    
    # SMB Shares Detection
    - pattern: "(?i)shares[:\\s]*([^\\n\\r]+)"
      description: "SMB Shares: {match1}"
      severity: "info"
      category: "shares"
    
    - pattern: "(?i)\\\\\\\\[^\\\\]+\\\\([^\\s]+)"
      description: "SMB Share Found: {match1}"
      severity: "info"
      category: "shares"
    
    - pattern: "(?i)ADMIN\\$"
      description: "Administrative share ADMIN$ detected"
      severity: "medium"
      category: "shares"
    
    - pattern: "(?i)C\\$"
      description: "System drive share C$ detected"
      severity: "medium"
      category: "shares"
    
    - pattern: "(?i)IPC\\$"
      description: "IPC share detected - inter-process communication"
      severity: "info"
      category: "shares"
    
    # Security Issues
    - pattern: "(?i)anonymous.*access.*enabled"
      description: "CRITICAL: SMB anonymous access enabled"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)guest.*access.*enabled"
      description: "WARNING: SMB guest access enabled"
      severity: "high"
      category: "security"
    
    - pattern: "(?i)signing.*disabled"
      description: "CRITICAL: SMB signing disabled - relay attacks possible"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)signing.*not.*required"
      description: "WARNING: SMB signing not required - potential security risk"
      severity: "high"
      category: "security"
    
    - pattern: "(?i)null.*session.*enabled"
      description: "HIGH: SMB null session enabled - information disclosure risk"
      severity: "high"
      category: "security"
    
    # SMB Protocol Versions
    - pattern: "(?i)smb.*1\\.0"
      description: "WARNING: SMBv1 detected - deprecated and vulnerable protocol"
      severity: "high"
      category: "security"
    
    - pattern: "(?i)smb.*2\\.[01]"
      description: "SMBv2 detected - secure protocol version"
      severity: "info"
      category: "protocol"
    
    - pattern: "(?i)smb.*3\\.[01]"
      description: "SMBv3 detected - latest secure protocol version"
      severity: "info"
      category: "protocol"
    
    # Authentication and Users
    - pattern: "(?i)account.*lockout"
      description: "Account lockout policy detected: check brute force protection"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)password.*policy"
      description: "Password policy information disclosed"
      severity: "low"
      category: "authentication"
    
    - pattern: "(?i)users[:\\s]*([^\\n\\r]+)"
      description: "SMB Users Enumerated: {match1}"
      severity: "medium"
      category: "enumeration"
    
    - pattern: "(?i)groups[:\\s]*([^\\n\\r]+)"
      description: "SMB Groups Enumerated: {match1}"
      severity: "medium"
      category: "enumeration"
    
    # Time and System Information
    - pattern: "(?i)system.*time[:\\s]*([^\\n\\r]+)"
      description: "System Time: {match1}"
      severity: "info"
      category: "system_info"
    
    - pattern: "(?i)server.*time[:\\s]*([^\\n\\r]+)"
      description: "Server Time: {match1}"
      severity: "info"
      category: "system_info"
    
    # Vulnerability Indicators
    - pattern: "(?i)ms08-067"
      description: "CRITICAL: MS08-067 vulnerability indicator detected"
      severity: "critical"
      category: "vulnerability"
    
    - pattern: "(?i)ms17-010"
      description: "CRITICAL: MS17-010 (EternalBlue) vulnerability indicator detected"
      severity: "critical"
      category: "vulnerability"
    
    - pattern: "(?i)vulnerable.*to.*([^\\n\\r]+)"
      description: "Vulnerability detected: {match1}"
      severity: "high"
      category: "vulnerability"
    
    # NetBIOS Information
    - pattern: "(?i)netbios.*name[:\\s]*([^\\n\\r]+)"
      description: "NetBIOS Name: {match1}"
      severity: "info"
      category: "netbios"
    
    - pattern: "(?i)mac.*address[:\\s]*([a-fA-F0-9:]+)"
      description: "MAC Address: {match1}"
      severity: "info"
      category: "network"

  technology_detection:
    - pattern: "(?i)windows.*server.*([0-9]{4})"
      technology: "Windows Server"
      version_group: 1
    
    - pattern: "(?i)windows.*(7|8|10|11)"
      technology: "Windows Desktop"
      version_group: 1
    
    - pattern: "(?i)samba.*([0-9]+\\.[0-9]+)"
      technology: "Samba"
      version_group: 1

requirements:
  tools:
    - name: "nmap"
      check_command: "nmap --version"
      install_hint: "apt-get install nmap"

debug:
  log_level: "info"
  trace_decisions: false
  show_command_output: false