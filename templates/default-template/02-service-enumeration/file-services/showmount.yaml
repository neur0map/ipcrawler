metadata:
  name: "NFS Share Enumeration"
  description: "NFS share enumeration using showmount to discover exported filesystems"
  type: "servicescan"
  priority: 10
  version: "1.0"
  author: "IPCrawler YAML Plugin System"

conditions:
  services:
    include: ["^nfs", "^rpcbind"]

options:
  - name: "timeout"
    type: "integer"
    default: 30
    help: "Command timeout in seconds"

execution:
  commands:
    - name: "showmount_exports"
      command: "showmount -e {address} 2>&1"
      timeout: 30
      output_file: "{protocol}_{port}_showmount.txt"

  manual_commands:
    - description: "(showmount) List NFS exports"
      command: "showmount -e {address}"
    - description: "(showmount) List NFS exports with detailed info"
      command: "showmount -e -v {address}"
    - description: "(showmount) List all mount points"
      command: "showmount -a {address}"
    - description: "(showmount) List directories mounted by clients"
      command: "showmount -d {address}"
    - description: "(mount) Mount NFS share"
      command: "mkdir /tmp/nfs_mount && mount -t nfs {address}:/export/path /tmp/nfs_mount"
    - description: "(rpcinfo) Query RPC services"
      command: "rpcinfo -p {address}"

output:
  patterns:
    # NFS Export Detection
    - pattern: "(?i)export list for ([^:\\n\\r]+):"
      description: "NFS server exports available: {match1}"
      severity: "info"
      category: "nfs_exports"
    
    - pattern: "(?i)^(/[^\\s]+)\\s+([^\\n\\r]+)"
      description: "NFS Export: {match1} accessible to {match2}"
      severity: "info"
      category: "nfs_exports"
    
    # World-readable exports (critical security issue)
    - pattern: "(?i)^(/[^\\s]+)\\s+.*\\*"
      description: "CRITICAL: World-readable NFS export: {match1}"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)^(/[^\\s]+)\\s+.*everyone"
      description: "CRITICAL: NFS export accessible to everyone: {match1}"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)^(/[^\\s]+)\\s+.*0\\.0\\.0\\.0"
      description: "CRITICAL: NFS export accessible to all IPs: {match1}"
      severity: "critical"
      category: "security"
    
    # Specific network access patterns
    - pattern: "(?i)^(/[^\\s]+)\\s+([0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)"
      description: "NFS Export: {match1} accessible to host {match2}"
      severity: "info"
      category: "nfs_exports"
    
    - pattern: "(?i)^(/[^\\s]+)\\s+([0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+/[0-9]+)"
      description: "NFS Export: {match1} accessible to network {match2}"
      severity: "info"
      category: "nfs_exports"
    
    - pattern: "(?i)^(/[^\\s]+)\\s+([a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})"
      description: "NFS Export: {match1} accessible to hostname {match2}"
      severity: "info"
      category: "nfs_exports"
    
    # Sensitive directories
    - pattern: "(?i)^(/home[/\\s])"
      description: "WARNING: Home directory NFS export detected: {match1}"
      severity: "high"
      category: "security"
    
    - pattern: "(?i)^(/root[/\\s])"
      description: "CRITICAL: Root directory NFS export detected: {match1}"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)^(/etc[/\\s])"
      description: "HIGH: System configuration directory NFS export: {match1}"
      severity: "high"
      category: "security"
    
    - pattern: "(?i)^(/var[/\\s])"
      description: "MEDIUM: Variable data directory NFS export: {match1}"
      severity: "medium"
      category: "security"
    
    - pattern: "(?i)^(/usr[/\\s])"
      description: "System directory NFS export: {match1}"
      severity: "medium"
      category: "security"
    
    - pattern: "(?i)^(/opt[/\\s])"
      description: "Optional software directory NFS export: {match1}"
      severity: "low"
      category: "security"
    
    - pattern: "(?i)^(/tmp[/\\s])"
      description: "Temporary directory NFS export: {match1}"
      severity: "low"
      category: "security"
    
    # Access control indicators
    - pattern: "(?i)^(/[^\\s]+)\\s+.*rw"
      description: "NFS Export with read-write access: {match1}"
      severity: "medium"
      category: "permissions"
    
    - pattern: "(?i)^(/[^\\s]+)\\s+.*ro"
      description: "NFS Export with read-only access: {match1}"
      severity: "info"
      category: "permissions"
    
    - pattern: "(?i)^(/[^\\s]+)\\s+.*no_root_squash"
      description: "CRITICAL: NFS export with no_root_squash: {match1}"
      severity: "critical"
      category: "security"
    
    - pattern: "(?i)^(/[^\\s]+)\\s+.*root_squash"
      description: "NFS export with root_squash security: {match1}"
      severity: "info"
      category: "security"
    
    - pattern: "(?i)^(/[^\\s]+)\\s+.*all_squash"
      description: "NFS export with all_squash security: {match1}"
      severity: "info"
      category: "security"
    
    # Error patterns
    - pattern: "(?i)mount.*failed"
      description: "NFS mount operation failed"
      severity: "info"
      category: "connectivity"
    
    - pattern: "(?i)rpc.*timeout"
      description: "RPC timeout - NFS service may be filtered"
      severity: "info"
      category: "connectivity"
    
    - pattern: "(?i)program not registered"
      description: "NFS service not registered with portmapper"
      severity: "info"
      category: "connectivity"
    
    - pattern: "(?i)permission denied"
      description: "NFS access denied"
      severity: "info"
      category: "authentication"
    
    - pattern: "(?i)no such file or directory"
      description: "NFS path not found"
      severity: "info"
      category: "connectivity"
    
    # Mount information
    - pattern: "(?i)mounted by ([^\\n\\r]+)"
      description: "NFS mounted by clients: {match1}"
      severity: "info"
      category: "nfs_clients"
    
    - pattern: "(?i)all mount points on ([^\\n\\r]+)"
      description: "NFS mount points on server: {match1}"
      severity: "info"
      category: "nfs_exports"
    
    # Version and protocol information
    - pattern: "(?i)nfs.*version.*([0-9]+\\.[0-9]+)"
      description: "NFS Version: {match1}"
      severity: "info"
      category: "version"
    
    - pattern: "(?i)nfs.*v([0-9]+)"
      description: "NFS Version: v{match1}"
      severity: "info"
      category: "version"
    
    # Security warnings for older NFS versions
    - pattern: "(?i)nfs.*v[12]"
      description: "WARNING: Legacy NFS version detected - security risks"
      severity: "medium"
      category: "security"
    
    - pattern: "(?i)nfs.*version.*[12]\\."
      description: "WARNING: Legacy NFS version detected - security risks"
      severity: "medium"
      category: "security"

  technology_detection:
    - pattern: "(?i)nfs.*version.*([0-9]+\\.[0-9]+)"
      technology: "NFS"
      version_group: 1
    
    - pattern: "(?i)nfs.*v([0-9]+)"
      technology: "NFS"
      version_group: 1
    
    - pattern: "(?i)linux"
      technology: "Linux NFS Server"
    
    - pattern: "(?i)solaris"
      technology: "Solaris NFS Server"
    
    - pattern: "(?i)freebsd"
      technology: "FreeBSD NFS Server"

requirements:
  tools:
    - name: "showmount"
      check_command: "showmount --help"
      install_hint: "apt-get install nfs-common"

debug:
  log_level: "info"
  trace_decisions: false
  show_command_output: false